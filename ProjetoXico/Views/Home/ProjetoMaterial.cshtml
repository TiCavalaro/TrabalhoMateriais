@model ProjetoXico.ViewModel.ProjetoMaterialViewModel

@{
    ViewData["Title"] = $"Materiais de {Model.Projeto.NomeProjeto} 🧱";
}

<div class="container min-vh-100 d-flex flex-column justify-content-start py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-warning">@ViewData["Title"]</h2>
        <button class="btn btn-warning btn-lg fw-bold" data-bs-toggle="modal" data-bs-target="#inserirModal">
            ➕ Adicionar Material
        </button>
    </div>

    @if (TempData["Mensagem"] != null)
    {
        <div class="alert alert-success text-center shadow">@TempData["Mensagem"]</div>
    }

    <div class="table-responsive shadow rounded-3 mb-4">
        <table class="table table-striped table-dark text-center align-middle">
            <thead class="table-warning text-dark">
                <tr>
                    <th>ID</th>
                    <th>Material</th>
                    <th>Quantidade</th>
                    <th>Adicional</th>
                    <th>Inserido em</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.MateriaisVinculados.Any())
                {
                    foreach (var item in Model.MateriaisVinculados)
                    {
                        <tr>
                            <td>@item.IdProjetoMaterial</td>
                            <td class="fw-semibold text-warning">@item.Material?.Descricao</td>
                            <td>@item.QuantidadeUtilizada</td>
                            <td>@(item.FlAdicional ? "✅ Sim" : "❌ Não")</td>
                            <td>@item.DataInsercao.ToString("dd/MM/yyyy")</td>
                            <td>
                                <div class="d-flex justify-content-center">
                                    <button class="btn btn-sm btn-outline-info me-2"
                                            data-bs-toggle="modal"
                                            data-bs-target="#editarModal"
                                            data-id="@item.IdProjetoMaterial"
                                            data-quantidade="@item.QuantidadeUtilizada"
                                            data-adicional="@item.FlAdicional">
                                        ✏️
                                    </button>
                                    <form asp-action="Excluir" asp-controller="TbProjetoMaterial" method="post" style="display:inline;">
                                        <input type="hidden" name="id" value="@item.IdProjetoMaterial" />
                                        <button type="submit" class="btn btn-sm btn-outline-danger"
                                                onclick="return confirm('Deseja realmente excluir este material do projeto?');">
                                            🗑️
                                        </button>
                                    </form>

                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr><td colspan="6" class="text-muted">Nenhum material vinculado a este projeto.</td></tr>
                }
            </tbody>
        </table>
    </div>

    <a asp-action="Index" asp-controller="TbProjeto" class="btn btn-outline-warning fw-bold">⬅️ Voltar para Projetos</a>
</div>

<!-- 🧩 Modal Inserir -->
<div class="modal fade" id="inserirModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light border-warning border-2 rounded-4 shadow-lg">
            <div class="modal-header border-warning">
                <h5 class="modal-title text-warning">➕ Adicionar Material</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form asp-action="Inserir" asp-controller="TbProjetoMaterial" method="post">
                    <input type="hidden" name="IdProjeto" value="@Model.Projeto.IdProjeto" />

                    <div class="mb-3">
                        <label class="form-label">Material 🧱</label>
                        <select class="form-select bg-secondary text-light border-warning" name="IdMaterial" required>
                            <option value="">Selecione um material...</option>
                            @foreach (var material in Model.MateriaisDisponiveis)
                            {
                                <option value="@material.IdMaterial">@material.Descricao</option>
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Quantidade 🔢</label>
                        <input type="number" step="0.01" class="form-control bg-secondary text-light border-warning" name="QuantidadeUtilizada" required>
                    </div>

                    <div class="form-check mt-3">
                        <input class="form-check-input border-warning" type="checkbox" name="FlAdicional" value="true" id="FlAdicional">
                        <label class="form-check-label" for="FlAdicional">Material adicional</label>
                        <input type="hidden" name="FlAdicional" value="false" />
                    </div>

                    <button type="submit" class="btn btn-warning w-100 mt-4 fw-bold">💾 Vincular Material</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ✏️ Modal Editar -->
<div class="modal fade" id="editarModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light border-info border-2 rounded-4 shadow-lg">
            <div class="modal-header border-info">
                <h5 class="modal-title text-info">✏️ Editar Material</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form asp-action="Atualizar" asp-controller="TbProjetoMaterial" method="post">
                    <input type="hidden" id="editarId" name="IdProjetoMaterial" />
                    <input type="hidden" name="IdProjeto" value="@Model.Projeto.IdProjeto" />

                    <div class="mb-3">
                        <label class="form-label">Quantidade 🔢</label>
                        <input type="number" step="0.01" class="form-control bg-secondary text-light border-info" id="editarQuantidade" name="QuantidadeUtilizada" required>
                    </div>

                    <div class="form-check mt-3">
                        <input class="form-check-input border-info" type="checkbox" id="editarAdicional" name="FlAdicional" value="true">
                        <label class="form-check-label" for="editarAdicional">Material adicional</label>
                        <input type="hidden" name="FlAdicional" value="false" />
                    </div>

                    <button type="submit" class="btn btn-info w-100 mt-4 fw-bold">💾 Atualizar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const editarModal = document.getElementById('editarModal');
    if (editarModal) {
        editarModal.addEventListener('show.bs.modal', event => {
            const button = event.relatedTarget;
            document.getElementById('editarId').value = button.getAttribute('data-id');
            document.getElementById('editarQuantidade').value = button.getAttribute('data-quantidade');
            document.getElementById('editarAdicional').checked = button.getAttribute('data-adicional') === 'true';
        });
    }
</script>
